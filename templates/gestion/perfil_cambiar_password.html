{% extends 'base.html' %}
{% block title %}Cambiar Contraseña{% endblock %}
{% block section_title %}Perfil{% endblock %}

{% block content %}
<div class="page-header-simple">
    <div class="breadcrumb">
        <a href="{% url 'gestion:perfil' %}">Mi perfil</a>
        <span class="breadcrumb-separator">/</span>
        <span>Cambiar contraseña</span>
    </div>
    <h1 class="page-title">Cambiar contraseña</h1>
    <p class="page-subtitle">Actualiza tu contraseña de acceso al sistema</p>
</div>

<div class="form-container-centered">
    <form method="post" class="form-layout">
        {% csrf_token %}
        
        <div class="form-card">
            <div class="form-card-header">
                <h2 class="form-card-title">Nueva contraseña</h2>
                <p class="form-card-subtitle">Ingresa tu contraseña actual y define una nueva</p>
            </div>
            <div class="form-card-body">
                {% if messages %}
                <div class="form-messages">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="form-group full-width">
                    <label class="form-label">Contraseña actual</label>
                    <div class="password-input-wrapper">
                        <input type="password" name="password_actual" class="form-input" 
                               placeholder="Ingresa tu contraseña actual" required>
                        <button type="button" class="password-toggle" onclick="togglePassword(this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Nueva contraseña</label>
                    <div class="password-input-wrapper">
                        <input type="password" name="password_nueva" id="password_nueva" class="form-input" 
                               placeholder="Ingresa tu nueva contraseña" required>
                        <button type="button" class="password-toggle" onclick="togglePassword(this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <!-- Requisitos de seguridad ISO 27001 -->
                    <div class="password-requirements">
                        <h4 class="requirements-title">Requisitos de seguridad:</h4>
                        <ul class="requirements-list">
                            <li id="req-length" class="requirement-unmet">
                                <i class="fas fa-circle"></i>
                                Mínimo 8 caracteres
                            </li>
                            <li id="req-uppercase" class="requirement-unmet">
                                <i class="fas fa-circle"></i>
                                Al menos una letra mayúscula (A-Z)
                            </li>
                            <li id="req-lowercase" class="requirement-unmet">
                                <i class="fas fa-circle"></i>
                                Al menos una letra minúscula (a-z)
                            </li>
                            <li id="req-number" class="requirement-unmet">
                                <i class="fas fa-circle"></i>
                                Al menos un número (0-9)
                            </li>
                            <li id="req-not-common" class="requirement-unmet">
                                <i class="fas fa-circle"></i>
                                No usar contraseñas comunes (password, 12345678, etc.)
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Confirmar nueva contraseña</label>
                    <div class="password-input-wrapper">
                        <input type="password" name="password_confirmar" id="password_confirmar" class="form-input" 
                               placeholder="Repite tu nueva contraseña" required>
                        <button type="button" class="password-toggle" onclick="togglePassword(this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <span class="password-match" id="password-match"></span>
                </div>
            </div>
        </div>

        <!-- Footer fijo -->
        <div class="form-footer">
            <a href="{% url 'gestion:perfil' %}" class="btn-secondary">Cancelar</a>
            <button type="submit" class="btn-primary">Cambiar contraseña</button>
        </div>
    </form>
</div>

<script>
function togglePassword(btn) {
    const input = btn.previousElementSibling;
    const icon = btn.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Lista de contraseñas comunes (sincronizada con el validador backend)
const COMMON_PASSWORDS = [
    '12345678', 'password', '123456789', '12345', '1234567',
    'password1', 'qwerty', 'abc123', '111111', '123123',
    'admin', 'letmein', 'welcome', 'monkey', '1234567890',
    'chile123', 'chile2024', 'santiago', 'admin123',
];

// Validación en tiempo real
const passwordInput = document.getElementById('password_nueva');
const confirmInput = document.getElementById('password_confirmar');

passwordInput.addEventListener('input', function() {
    const password = this.value;
    
    // Verificar requisitos
    updateRequirement('req-length', password.length >= 8);
    updateRequirement('req-uppercase', /[A-Z]/.test(password));
    updateRequirement('req-lowercase', /[a-z]/.test(password));
    updateRequirement('req-number', /[0-9]/.test(password));
    
    // Verificar que no sea contraseña común
    const isCommon = COMMON_PASSWORDS.some(common => 
        password.toLowerCase().includes(common.toLowerCase())
    );
    updateRequirement('req-not-common', !isCommon);
    
    // El requisito de "diferente" solo se puede validar en el servidor
    // Lo dejamos como pendiente hasta que se envíe el formulario
    
    checkMatch();
});

confirmInput.addEventListener('input', checkMatch);

function updateRequirement(id, cumple) {
    const element = document.getElementById(id);
    const icon = element.querySelector('i');
    
    if (cumple) {
        element.classList.add('requirement-met');
        element.classList.remove('requirement-unmet');
        if (icon) icon.className = 'fas fa-check-circle';
    } else {
        element.classList.add('requirement-unmet');
        element.classList.remove('requirement-met');
        if (icon) icon.className = 'fas fa-circle';
    }
}

function checkMatch() {
    const password = passwordInput.value;
    const confirm = confirmInput.value;
    const matchSpan = document.getElementById('password-match');
    
    if (confirm.length === 0) {
        matchSpan.textContent = '';
        matchSpan.className = 'password-match';
    } else if (password === confirm) {
        matchSpan.textContent = '✓ Las contraseñas coinciden';
        matchSpan.className = 'password-match match-success';
    } else {
        matchSpan.textContent = '✗ Las contraseñas no coinciden';
        matchSpan.className = 'password-match match-error';
    }
}
</script>
{% endblock %}